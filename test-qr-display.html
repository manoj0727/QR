<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        #qr-display {
            margin-top: 20px;
            border: 2px dashed #ddd;
            padding: 20px;
            min-height: 300px;
            background: #f9f9f9;
        }
        
        #console {
            margin-top: 20px;
            padding: 10px;
            background: #1e1e1e;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .error {
            color: #f00;
        }
        
        .success {
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>QR Code Display Test</h1>
    
    <div>
        <button onclick="createTestProduct()">Create Test Product</button>
        <button onclick="testDisplayQR()">Test Display QR</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div id="qr-display">
        <!-- QR code will be displayed here -->
    </div>
    
    <div id="console">
        <div class="log-entry">Console output will appear here...</div>
    </div>
    
    <script>
        const consoleDiv = document.getElementById('console');
        
        function log(message, type = 'log') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '<div class="log-entry">Console cleared.</div>';
        }
        
        async function createTestProduct() {
            log('Creating test product...');
            
            const testData = {
                name: "Test Product " + Date.now(),
                type: "Shirt",
                size: "M",
                color: "Blue",
                initial_quantity: 10,
                price: 299,
                description: "Test product for QR code display",
                minStock: 5,
                location: "A-12",
                material: "Cotton",
                brand: "Test Brand"
            };
            
            try {
                const response = await fetch('https://localhost:3000/api/products/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    log('Product created successfully!', 'success');
                    log('Product ID: ' + result.product_id);
                    log('QR Code data length: ' + result.qr_code.length);
                    
                    // Display the QR code
                    displayQRCode(result.qr_code, result.product_id);
                } else {
                    log('Failed to create product: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Error: ' + error.message, 'error');
                log('Make sure the backend server is running on https://localhost:3000', 'error');
            }
        }
        
        function displayQRCode(qrDataUrl, productId) {
            log('Displaying QR code for product: ' + productId);
            
            const qrDisplay = document.getElementById('qr-display');
            if (!qrDisplay) {
                log('QR display element not found!', 'error');
                return;
            }
            
            // Clear existing content
            qrDisplay.innerHTML = '';
            
            // Create container
            const container = document.createElement('div');
            container.style.textAlign = 'center';
            container.style.padding = '20px';
            
            // Create image element
            const img = document.createElement('img');
            img.src = qrDataUrl;
            img.style.width = '256px';
            img.style.height = '256px';
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.border = '2px solid #e0e0e0';
            img.style.borderRadius = '8px';
            img.style.padding = '10px';
            img.style.backgroundColor = 'white';
            img.alt = 'QR Code for ' + productId;
            
            img.onload = () => {
                log('QR code image loaded successfully!', 'success');
                log('Image dimensions: ' + img.naturalWidth + 'x' + img.naturalHeight);
            };
            
            img.onerror = () => {
                log('Failed to load QR code image!', 'error');
                log('Data URL start: ' + qrDataUrl.substring(0, 50), 'error');
            };
            
            // Add product ID label
            const label = document.createElement('p');
            label.textContent = 'Product ID: ' + productId;
            label.style.marginTop = '10px';
            label.style.fontWeight = 'bold';
            
            container.appendChild(img);
            container.appendChild(label);
            qrDisplay.appendChild(container);
            
            log('QR code element added to DOM');
        }
        
        function testDisplayQR() {
            // Test with a dummy QR code
            const dummyQR = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            displayQRCode(dummyQR, 'TEST-123');
            log('Displayed dummy QR code for testing');
        }
        
        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };
    </script>
</body>
</html>