<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Viewer - QR Inventory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .tab:hover {
            background: #f0f0f0;
            color: #333;
        }
        .tab.active:hover {
            background: #667eea;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .qr-preview {
            max-width: 100px;
            cursor: pointer;
        }
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            float: right;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Database Viewer</h1>
        <p style="color: #666;">Real-time view of your SQLite database</p>
        
        <div class="info">
            <strong>Current Database:</strong> <code id="db-location">Loading...</code><br>
            <strong>Database Type:</strong> <span id="db-type">SQLite (Local)</span><br>
            <strong>Last Updated:</strong> <span id="last-updated">-</span>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Products</h3>
                <div class="stat-number" id="total-products">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Stock</h3>
                <div class="stat-number" id="total-stock">0</div>
            </div>
            <div class="stat-card">
                <h3>Transactions</h3>
                <div class="stat-number" id="total-transactions">0</div>
            </div>
            <div class="stat-card">
                <h3>QR Codes</h3>
                <div class="stat-number" id="total-qr">0</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="loadData()">ðŸ”„ Refresh</button>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('products')">Products</button>
            <button class="tab" onclick="showTab('transactions')">Transactions</button>
            <button class="tab" onclick="showTab('qr_codes')">QR Codes</button>
            <button class="tab" onclick="showTab('sql')">SQL Query</button>
        </div>

        <div id="products" class="tab-content">
            <h2>Products Table</h2>
            <div id="products-table" class="loading">Loading...</div>
        </div>

        <div id="transactions" class="tab-content" style="display: none;">
            <h2>Transactions History</h2>
            <div id="transactions-table" class="loading">Loading...</div>
        </div>

        <div id="qr_codes" class="tab-content" style="display: none;">
            <h2>QR Codes</h2>
            <div id="qr-table" class="loading">Loading...</div>
        </div>

        <div id="sql" class="tab-content" style="display: none;">
            <h2>Custom SQL Query</h2>
            <p style="color: #666; margin: 10px 0;">Run custom SQL queries (SELECT only for safety)</p>
            <textarea id="sql-query" style="width: 100%; height: 100px; padding: 10px; font-family: monospace;" placeholder="SELECT * FROM products WHERE quantity > 10">SELECT * FROM products LIMIT 10</textarea>
            <button onclick="runQuery()" style="margin: 10px 0; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Run Query</button>
            <div id="query-result"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentTab = 'products';

        async function loadData() {
            try {
                // Update location info
                document.getElementById('db-location').textContent = 'backend/inventory.db';
                document.getElementById('last-updated').textContent = new Date().toLocaleString();

                // Load statistics
                const [products, transactions, inventory] = await Promise.all([
                    fetch(`${API_URL}/products`).then(r => r.json()),
                    fetch(`${API_URL}/transactions`).then(r => r.json()),
                    fetch(`${API_URL}/inventory/summary`).then(r => r.json())
                ]);

                // Update stats
                document.getElementById('total-products').textContent = products.length;
                document.getElementById('total-stock').textContent = inventory.total_items || 0;
                document.getElementById('total-transactions').textContent = transactions.length;
                document.getElementById('total-qr').textContent = products.length; // Each product has a QR

                // Load products table
                let productsHTML = '<table><thead><tr><th>ID</th><th>Product ID</th><th>Name</th><th>Type</th><th>Size</th><th>Color</th><th>Quantity</th><th>Created</th></tr></thead><tbody>';
                products.forEach(p => {
                    productsHTML += `<tr>
                        <td>${p.id}</td>
                        <td><code>${p.product_id}</code></td>
                        <td>${p.name}</td>
                        <td>${p.type}</td>
                        <td>${p.size}</td>
                        <td>${p.color || '-'}</td>
                        <td><strong>${p.quantity}</strong></td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    </tr>`;
                });
                productsHTML += '</tbody></table>';
                document.getElementById('products-table').innerHTML = productsHTML;

                // Load transactions table
                let transHTML = '<table><thead><tr><th>ID</th><th>Product ID</th><th>Action</th><th>Quantity</th><th>By</th><th>Location</th><th>Time</th></tr></thead><tbody>';
                transactions.slice(0, 50).forEach(t => {
                    const actionColor = t.action.includes('IN') || t.action === 'INITIAL_STOCK' ? 'green' : 'red';
                    transHTML += `<tr>
                        <td>${t.id}</td>
                        <td><code>${t.product_id}</code></td>
                        <td style="color: ${actionColor}; font-weight: bold;">${t.action}</td>
                        <td>${t.quantity}</td>
                        <td>${t.performed_by || '-'}</td>
                        <td>${t.location || '-'}</td>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                transHTML += '</tbody></table>';
                document.getElementById('transactions-table').innerHTML = transHTML;

                // Load QR codes table
                let qrHTML = '<table><thead><tr><th>Product ID</th><th>Product Name</th><th>QR Preview</th><th>Data Size</th></tr></thead><tbody>';
                for (const p of products.slice(0, 20)) {
                    const qrData = await fetch(`${API_URL}/qr/${p.product_id}`).then(r => r.json());
                    if (qrData.qr_code) {
                        qrHTML += `<tr>
                            <td><code>${p.product_id}</code></td>
                            <td>${p.name}</td>
                            <td><img src="${qrData.qr_code}" class="qr-preview" onclick="window.open('${qrData.qr_code}')" /></td>
                            <td>${Math.round(qrData.qr_code.length / 1024)}KB</td>
                        </tr>`;
                    }
                }
                qrHTML += '</tbody></table>';
                document.getElementById('qr-table').innerHTML = qrHTML;

            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelectorAll('.tab-content > div').forEach(el => {
                    if (el.classList.contains('loading')) {
                        el.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
                    }
                });
            }
        }

        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            event.target.classList.add('active');
            document.getElementById(tabName).style.display = 'block';
        }

        async function runQuery() {
            const query = document.getElementById('sql-query').value;
            if (!query.toLowerCase().startsWith('select')) {
                alert('Only SELECT queries are allowed for safety!');
                return;
            }
            
            document.getElementById('query-result').innerHTML = '<div class="loading">Running query...</div>';
            
            // Note: This would need a backend endpoint to execute SQL
            document.getElementById('query-result').innerHTML = `
                <div class="info">
                    <strong>Note:</strong> To run custom SQL queries, use the terminal:<br>
                    <code>sqlite3 backend/inventory.db "${query}"</code>
                </div>
            `;
        }

        // Load data on page load
        loadData();
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>