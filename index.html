<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QR Inventory System</title>
    
    <!-- Original CSS files -->
    <link rel="stylesheet" href="assets/css/modern-dashboard.css">
    <link rel="stylesheet" href="assets/css/realtime-tracking.css">
    <link rel="stylesheet" href="assets/css/dashboard-modern.css">
    <link rel="stylesheet" href="assets/css/transaction-history.css">
    <link rel="stylesheet" href="assets/css/original-styles.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/top-header.css">
    <link rel="stylesheet" href="assets/css/sidebar-collapse.css">
    <link rel="stylesheet" href="assets/css/transaction-enhanced.css">
    <link rel="stylesheet" href="assets/css/tailor-management.css">
    <link rel="stylesheet" href="assets/css/employee-management.css">
    <link rel="stylesheet" href="assets/css/attendance-management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailor Management Module -->
    <script src="tailor/assets/js/tailor-management.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered: ', registration))
                    .catch(error => console.log('SW registration failed: ', error));
            });
        }
    </script>
    
    <!-- Authentication System -->
    <script src="auth/users/users-db.js"></script>
    <script src="auth/session/session-manager.js"></script>
    
    <!-- Login Check -->
    <script>
        // Require admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            if (!SessionManager.requireAuth('admin')) {
                return; // Will redirect if not authenticated or wrong role
            }
            
            // Update user display
            const currentUser = SessionManager.getCurrentUser();
            if (currentUser) {
                console.log('Admin dashboard loaded for:', currentUser.name);
            }
        });
    </script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>QR Inventory</h2>
                <button class="sidebar-collapse-btn" onclick="collapseSidebar()" title="Collapse Menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="nav-menu">
                <ul>
                    <li><a href="#" onclick="showSection('dashboard', event)" class="nav-item active" data-section="dashboard" data-tooltip="Dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('create-product', event)" class="nav-item" data-section="create-product" data-tooltip="Create Product">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create Product</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('scan-qr', event)" class="nav-item" data-section="scan-qr" data-tooltip="Scan QR">
                        <i class="fas fa-qrcode"></i>
                        <span>Scan QR Code</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('inventory', event)" class="nav-item" data-section="inventory" data-tooltip="Inventory">
                        <i class="fas fa-boxes"></i>
                        <span>Inventory</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('transactions', event)" class="nav-item" data-section="transactions" data-tooltip="Transactions">
                        <i class="fas fa-receipt"></i>
                        <span>Transactions</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('tailor-management', event)" class="nav-item" data-section="tailor-management" data-tooltip="Tailor Mgmt">
                        <i class="fas fa-users"></i>
                        <span>Tailor Management</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('employee-management', event)" class="nav-item" data-section="employee-management" data-tooltip="Employee Mgmt">
                        <i class="fas fa-user-tie"></i>
                        <span>Employee Management</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('attendance-management', event)" class="nav-item" data-section="attendance-management" data-tooltip="Attendance">
                        <i class="fas fa-user-clock"></i>
                        <span>Attendance System</span>
                    </a></li>
                    
                    <li><a href="#" onclick="showSection('reports', event)" class="nav-item" data-section="reports" data-tooltip="Reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Navigation Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="menu-toggle-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-title">
                        <h1>QR Inventory System</h1>
                        <span class="header-subtitle" id="current-page">Dashboard</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="header-icon-btn" onclick="toggleFullscreen()" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                    
                    <div class="user-menu-wrapper">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <div class="user-avatar">A</div>
                            <span class="user-name">Admin</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        
                        <div class="user-dropdown" id="user-dropdown">
                            <a href="#" onclick="showProfile()">
                                <i class="fas fa-user"></i> Profile
                            </a>
                            <a href="#" onclick="showSettings()">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                            <hr>
                            <a href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="section-content">
                    <div class="dashboard-header">
                        <h2>Dashboard Overview</h2>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-cube"></i>
                            </div>
                            <div class="stat-details">
                                <span class="stat-label">Total Products</span>
                                <span class="stat-value" id="total-products">0</span>
                                <span class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> +12%
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-details">
                                <span class="stat-label">Total Items</span>
                                <span class="stat-value" id="total-items">0</span>
                                <span class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> Updated
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div class="stat-details">
                                <span class="stat-label">Product Types</span>
                                <span class="stat-value" id="product-types">0</span>
                                <span class="stat-change">
                                    <i class="fas fa-minus"></i> Stable
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stat-details">
                                <span class="stat-label">Recent Transactions</span>
                                <span class="stat-value" id="recent-transactions">0</span>
                                <span class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i> Active
                                </span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-details">
                                <span class="stat-label">Low Stock Items</span>
                                <span class="stat-value" id="low-stock">0</span>
                                <span class="stat-change negative">
                                    <i class="fas fa-arrow-down"></i> Alert
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Real-time User Activity Tracking -->
                    <div class="realtime-tracking-section">
                        <h3 class="section-header">
                            <i class="fas fa-users-cog"></i> Real-time User Activity
                            <span class="live-indicator">
                                <span class="pulse"></span> LIVE
                            </span>
                        </h3>
                        
                        <div class="tracking-grid">
                            <!-- Currently Online Users -->
                            <div class="tracking-card">
                                <div class="tracking-header">
                                    <h4><i class="fas fa-circle text-success"></i> Currently Online</h4>
                                    <span class="user-count" id="online-count">0</span>
                                </div>
                                <div class="online-users-list" id="online-users">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Recent Login Activity -->
                            <div class="tracking-card">
                                <div class="tracking-header">
                                    <h4><i class="fas fa-sign-in-alt"></i> Recent Logins</h4>
                                    <button class="btn-small" onclick="clearLoginHistory()">Clear</button>
                                </div>
                                <div class="activity-log" id="login-activity">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Employee Product Tracking -->
                            <div class="tracking-card wide">
                                <div class="tracking-header">
                                    <h4><i class="fas fa-chart-bar"></i> Employee Product Activity</h4>
                                    <select id="activity-period" onchange="updateProductTracking(this.value)">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                    </select>
                                </div>
                                <div class="product-tracking-table">
                                    <table class="tracking-table">
                                        <thead>
                                            <tr>
                                                <th>Employee</th>
                                                <th>Role</th>
                                                <th>Products Added</th>
                                                <th>Last Activity</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="product-tracking-body">
                                            <!-- Will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Activity Feed -->
                        <div class="live-feed-section">
                            <div class="feed-header">
                                <h4><i class="fas fa-stream"></i> Live Activity Feed</h4>
                                <div class="feed-controls">
                                    <button class="filter-btn active" data-filter="all">All</button>
                                    <button class="filter-btn" data-filter="login">Logins</button>
                                    <button class="filter-btn" data-filter="logout">Logouts</button>
                                    <button class="filter-btn" data-filter="products">Products</button>
                                </div>
                            </div>
                            <div class="live-feed" id="live-activity-feed">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Create Product Section -->
            <div id="create-product" class="section">
                <iframe src="components/pages/product-simple.html" style="width: 100%; height: calc(100vh - 70px); border: none;"></iframe>
            </div>
            
            <!-- Scan QR Section -->
            <div id="scan-qr" class="section">
                <div class="section-content">
                    <h2>Scan QR Code</h2>
                    
                    <div class="scan-options">
                        <button onclick="startScanner()" class="btn btn-primary">Start Camera Scanner</button>
                        <button onclick="showManualEntry()" class="btn btn-secondary">Manual Entry</button>
                    </div>
                    
                    <div id="scanner-container" style="display: none;">
                        <div class="scanner-wrapper">
                            <p id="camera-info" style="text-align: center; color: #666; margin-bottom: 1rem;">
                                Requesting camera permission...
                            </p>
                            <div class="reader-container">
                                <div id="reader"></div>
                            </div>
                            <div id="camera-loading" style="text-align: center; padding: 2rem; display: none;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p style="margin-top: 1rem;">Initializing camera...</p>
                                </div>
                            </div>
                            <button onclick="stopScanner()" class="btn btn-danger" style="margin-top: 1rem; display: block; margin-left: auto; margin-right: auto;">Stop Scanner</button>
                        </div>
                    </div>
                    
                    <div id="manual-entry" style="display: none;">
                        <div class="form-group">
                            <label for="manual-product-id">Enter Product ID</label>
                            <input type="text" id="manual-product-id" placeholder="e.g., SHI-M-ABC123">
                        </div>
                        <button onclick="manualLookup()" class="btn btn-primary">Lookup Product</button>
                    </div>
                    
                    <div id="scan-result" class="scan-result" style="display: none;">
                        <div id="product-details"></div>
                        
                        <h3>Update Inventory</h3>
                        <form id="inventory-action-form" class="form">
                            <div class="form-group">
                                <label for="action">Action</label>
                                <select id="action" required>
                                    <option value="">Select Action</option>
                                    <option value="IN">Add Items (Stock In)</option>
                                    <option value="OUT">Remove Items (Stock Out)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="quantity">Quantity</label>
                                <input type="number" id="quantity" value="1" min="1" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="performed-by">Performed By</label>
                                <input type="text" id="performed-by" placeholder="Enter your name">
                            </div>
                            
                            <div class="form-group">
                                <label for="location">Location (Optional)</label>
                                <input type="text" id="location" placeholder="e.g., Warehouse A">
                            </div>
                            
                            <div class="form-group">
                                <label for="notes">Notes (Optional)</label>
                                <textarea id="notes" rows="2"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Update Inventory</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Section -->
            <div id="inventory" class="section">
                <iframe src="components/pages/inventory-advanced.html" style="width: 100%; height: calc(100vh - 70px); border: none;"></iframe>
            </div>
            
            <!-- Transactions Section -->
            <div id="transactions" class="section">
                <div class="inventory-container trans-enhanced">
                    <!-- Enhanced Header Bar -->
                    <div class="inventory-header trans-header-white">
                        <div class="header-left">
                            <h1 class="trans-title">Transaction History</h1>
                            <span class="record-count trans-count" id="trans-record-count">0 Transactions</span>
                        </div>
                    </div>

                    <!-- Enhanced Filter Navigation Bar -->
                    <nav class="trans-filter-nav">
                        <div class="filter-nav-container">
                            <!-- Search Section -->
                            <div class="nav-search-section">
                                <div class="search-input-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input 
                                        type="text" 
                                        class="nav-search-input" 
                                        placeholder="Search transactions..." 
                                        id="search-transactions" 
                                        oninput="searchTransactions()"
                                    >
                                </div>
                            </div>
                            
                            <!-- Filters Section -->
                            <div class="nav-filters-section">
                                <!-- Date Filter -->
                                <div class="nav-filter-item">
                                    <label class="nav-filter-label">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Date</span>
                                    </label>
                                    <select id="date-filter" class="nav-select" onchange="filterTransactions()">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                                
                                <!-- Action Filter -->
                                <div class="nav-filter-item">
                                    <label class="nav-filter-label">
                                        <i class="fas fa-exchange-alt"></i>
                                        <span>Status</span>
                                    </label>
                                    <select id="type-filter" class="nav-select" onchange="filterTransactions()">
                                        <option value="all">All Status</option>
                                        <option value="STOCK_IN">Stock In</option>
                                        <option value="STOCK_OUT">Stock Out</option>
                                        <option value="SALE">Removed</option>
                                        <option value="INITIAL_STOCK">Updated</option>
                                    </select>
                                </div>
                                
                                <!-- Clear Filters Button -->
                                <button class="clear-filters-btn" onclick="clearAllFilters()" title="Clear all filters">
                                    <i class="fas fa-times-circle"></i>
                                    Clear
                                </button>
                            </div>
                            
                            <!-- Entries Section -->
                            <div class="nav-entries-section">
                                <div class="nav-entries-wrapper">
                                    <label class="nav-entries-label">Show</label>
                                    <select id="per-page-trans" class="nav-select-entries" onchange="updateTransPerPage()">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span class="nav-entries-text">entries</span>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <!-- Enhanced Table Wrapper -->
                    <div class="table-wrapper trans-table-wrapper">
                        <!-- Enhanced Transactions Table -->
                        <table class="inventory-table trans-table-enhanced" id="transactions-table">
                            <thead>
                                <tr>
                                    <th width="10%">PRODUCT ID</th>
                                    <th width="18%">Date & Time</th>
                                    <th width="22%">Product Name</th>
                                    <th width="12%">Status</th>
                                    <th width="10%">Size</th>
                                    <th width="10%">Qty</th>
                                    <th width="12%">User</th>
                                    <th width="10%">Location</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list">
                                <!-- Transaction rows will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-wrapper">
                        <div class="pagination-info">
                            Showing <span id="trans-start-record">1</span> to <span id="trans-end-record">25</span> 
                            of <span id="trans-total-records">125</span> entries
                        </div>
                        
                        <div class="pagination">
                            <button class="page-btn" onclick="previousPage()" id="prev-btn" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="page-number active">1</button>
                            <button class="page-number">2</button>
                            <button class="page-number">3</button>
                            <span class="page-dots">...</span>
                            <button class="page-number">5</button>
                            <button class="page-btn" onclick="nextPage()" id="next-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="empty-state trans-empty" style="display: none;">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>No transactions found</h3>
                        <p>Start by adding some inventory transactions</p>
                    </div>
                </div>
            </div>
            
            <!-- Tailor Management Section -->
            <div id="tailor-management" class="section">
                <div class="tailor-management-container">
                    <div class="tailor-header">
                        <div class="header-content">
                            <h2>Tailor Management</h2>
                            <p class="header-subtitle">Manage tailors, track performance, and oversee operations</p>
                        </div>
                        <div class="tailor-stats">
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="total-tailors">0</span>
                                    <span class="stat-label">Active Tailors</span>
                                </div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="active-orders">0</span>
                                    <span class="stat-label">Active Orders</span>
                                </div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="avg-rating">4.8</span>
                                    <span class="stat-label">Avg Rating</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modern-tab-nav">
                        <div class="tab-buttons">
                            <button class="modern-tab-btn active" data-tab="tailors" onclick="tailorManager.switchTab('tailors')">
                                <i class="fas fa-users"></i>
                                <span>Tailors</span>
                            </button>
                            <button class="modern-tab-btn" data-tab="assignments" onclick="tailorManager.switchTab('assignments')">
                                <i class="fas fa-tasks"></i>
                                <span>Assignments</span>
                            </button>
                            <button class="modern-tab-btn" data-tab="notifications" onclick="tailorManager.switchTab('notifications')">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </button>
                        </div>
                    </div>

                    <div id="tailors-tab" class="modern-tab-content active">
                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-user-plus"></i> Add New Tailor</h3>
                                    <p>Register a new tailor to the system</p>
                                </div>
                                <div class="section-actions">
                                    <button class="btn btn-outline" onclick="importTailors()">
                                        <i class="fas fa-upload"></i> Import
                                    </button>
                                </div>
                            </div>
                            
                            <form class="modern-form" id="add-tailor-form" onsubmit="tailorManager.addTailor(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tailor-name"><i class="fas fa-user"></i> Full Name</label>
                                        <input type="text" id="tailor-name" name="name" required placeholder="Enter tailor's full name">
                                    </div>
                                    <div class="form-group">
                                        <label for="tailor-username"><i class="fas fa-user-circle"></i> Username</label>
                                        <input type="text" id="tailor-username" name="username" required placeholder="Username for login">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tailor-password"><i class="fas fa-lock"></i> Password</label>
                                        <div class="password-field">
                                            <input type="text" id="tailor-password" name="password" required placeholder="Password">
                                            <button type="button" class="btn btn-sm" onclick="tailorManager.generatePassword()">
                                                <i class="fas fa-sync"></i> Generate
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="tailor-phone"><i class="fas fa-phone"></i> Phone Number</label>
                                        <input type="tel" id="tailor-phone" name="phone" required placeholder="+91 98765 43210">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tailor-email"><i class="fas fa-envelope"></i> Email Address</label>
                                        <input type="email" id="tailor-email" name="email" placeholder="tailor@example.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="tailor-specialty"><i class="fas fa-star"></i> Specialty</label>
                                        <select id="tailor-specialty" name="specialty">
                                            <option value="">Select Specialty</option>
                                            <option value="shirts">Shirts</option>
                                            <option value="pants">Pants</option>
                                            <option value="suits">Suits</option>
                                            <option value="dresses">Dresses</option>
                                            <option value="alterations">Alterations</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tailor-experience"><i class="fas fa-clock"></i> Experience (Years)</label>
                                        <input type="number" id="tailor-experience" name="experience" min="0" placeholder="5">
                                    </div>
                                    <div class="form-group">
                                        <label for="tailor-rate"><i class="fas fa-rupee-sign"></i> Hourly Rate</label>
                                        <input type="number" id="tailor-rate" name="rate" min="0" step="0.01" placeholder="500">
                                    </div>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="tailor-address"><i class="fas fa-map-marker-alt"></i> Address</label>
                                    <textarea id="tailor-address" name="address" rows="3" placeholder="Complete address with pincode"></textarea>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Add Tailor
                                    </button>
                                    <button type="reset" class="btn btn-outline">
                                        <i class="fas fa-undo"></i> Reset Form
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-list"></i> Tailor Directory</h3>
                                    <p>View and manage all registered tailors</p>
                                </div>
                                <div class="section-actions">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="tailor-search" placeholder="Search tailors..." oninput="searchTailors()">
                                    </div>
                                    <div class="filter-group">
                                        <select id="specialty-filter" onchange="filterTailors()">
                                            <option value="">All Specialties</option>
                                            <option value="shirts">Shirts</option>
                                            <option value="pants">Pants</option>
                                            <option value="suits">Suits</option>
                                            <option value="dresses">Dresses</option>
                                            <option value="alterations">Alterations</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-table-container">
                                <table class="modern-table">
                                    <thead>
                                        <tr>
                                            <th>Tailor Details</th>
                                            <th>Contact</th>
                                            <th>Specialty</th>
                                            <th>Experience</th>
                                            <th>Rate</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tailors-table-body">
                                        <!-- Tailors will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Assignments Tab -->
                    <div id="assignments-tab" class="modern-tab-content">
                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-plus-circle"></i> Create Assignment</h3>
                                    <p>Assign work to tailors</p>
                                </div>
                            </div>
                            
                            <form class="modern-form" id="assignment-form" onsubmit="tailorManager.createAssignment(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignment-tailor"><i class="fas fa-user"></i> Select Tailor</label>
                                        <select id="assignment-tailor" name="tailor_id" required>
                                            <option value="">Choose a tailor...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="assignment-priority"><i class="fas fa-flag"></i> Priority</label>
                                        <select id="assignment-priority" name="priority">
                                            <option value="normal">Normal</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignment-title"><i class="fas fa-tag"></i> Assignment Title</label>
                                        <input type="text" id="assignment-title" name="title" required placeholder="e.g., Stitch 10 shirts">
                                    </div>
                                    <div class="form-group">
                                        <label for="assignment-quantity"><i class="fas fa-sort-numeric-up"></i> Quantity</label>
                                        <input type="number" id="assignment-quantity" name="quantity" min="1" required placeholder="10">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assignment-deadline"><i class="fas fa-calendar"></i> Deadline</label>
                                        <input type="datetime-local" id="assignment-deadline" name="deadline" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="assignment-order"><i class="fas fa-receipt"></i> Order Number</label>
                                        <input type="text" id="assignment-order" name="order_number" placeholder="Optional">
                                    </div>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="assignment-description"><i class="fas fa-info-circle"></i> Description</label>
                                    <textarea id="assignment-description" name="description" rows="3" placeholder="Detailed instructions for the tailor..."></textarea>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Assign Work
                                    </button>
                                    <button type="reset" class="btn btn-outline">
                                        <i class="fas fa-undo"></i> Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-list-alt"></i> Active Assignments</h3>
                                    <p>Track ongoing work assignments</p>
                                </div>
                                <div class="section-actions">
                                    <select id="assignment-filter" onchange="filterAssignments()">
                                        <option value="">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="accepted">Accepted</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="assignments-grid" id="assignments-list">
                                <!-- Assignments will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Tab -->
                    <div id="notifications-tab" class="modern-tab-content">
                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-bell"></i> Send Notification</h3>
                                    <p>Send updates and alerts to tailors</p>
                                </div>
                            </div>
                            
                            <form class="modern-form" id="notification-form" onsubmit="tailorManager.sendNotification(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="notification-tailor"><i class="fas fa-user"></i> Select Tailor</label>
                                        <select id="notification-tailor" name="tailor_id" required>
                                            <option value="">Choose a tailor...</option>
                                            <option value="all">All Tailors</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="notification-type"><i class="fas fa-tag"></i> Type</label>
                                        <select id="notification-type" name="type">
                                            <option value="info">Information</option>
                                            <option value="assignment">Assignment</option>
                                            <option value="reminder">Reminder</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="notification-title"><i class="fas fa-heading"></i> Title</label>
                                    <input type="text" id="notification-title" name="title" required placeholder="Notification title">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="notification-message"><i class="fas fa-comment"></i> Message</label>
                                    <textarea id="notification-message" name="message" rows="4" required placeholder="Type your message here..."></textarea>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Send Notification
                                    </button>
                                    <button type="reset" class="btn btn-outline">
                                        <i class="fas fa-undo"></i> Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-section">
                            <div class="section-header">
                                <div class="header-text">
                                    <h3><i class="fas fa-history"></i> Recent Notifications</h3>
                                    <p>View sent notifications</p>
                                </div>
                            </div>
                            
                            <div class="notifications-list" id="notifications-history">
                                <!-- Notifications will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Employee Management Section -->
            <div id="employee-management" class="section">
                <div class="employee-management-container">
                    <div class="employee-header">
                        <div class="header-content">
                            <h2>Employee Management</h2>
                            <p class="header-subtitle">Manage employees, track performance, and handle notifications</p>
                        </div>
                        <div class="employee-stats">
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="total-employees">0</span>
                                    <span class="stat-label">Active Employees</span>
                                </div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="employee-qr-today">0</span>
                                    <span class="stat-label">QR Operations Today</span>
                                </div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="pending-notifications">0</span>
                                    <span class="stat-label">Unread Notifications</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Actions -->
                    <div class="employee-actions">
                        <div class="action-buttons">
                            <button onclick="showEmployeeRegistration()" class="btn btn-primary">
                                <i class="fas fa-user-plus"></i> Register Employee
                            </button>
                            <button onclick="showNotificationModal()" class="btn btn-secondary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </div>
                    </div>
                    
                    <!-- Employee Tabs -->
                    <div class="employee-tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="showEmployeeTab('list')" data-tab="list">
                                <i class="fas fa-list"></i> Employee List
                            </button>
                            <button class="tab-button" onclick="showEmployeeTab('performance')" data-tab="performance">
                                <i class="fas fa-chart-line"></i> Performance
                            </button>
                            <button class="tab-button" onclick="showEmployeeTab('activities')" data-tab="activities">
                                <i class="fas fa-history"></i> Activities
                            </button>
                        </div>
                        
                        <!-- Employee List Tab -->
                        <div id="employee-list-tab" class="tab-content active">
                            <div class="employees-table-container">
                                <table class="employees-table" id="employees-table">
                                    <thead>
                                        <tr>
                                            <th>Employee ID</th>
                                            <th>Name</th>
                                            <th>Department</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                            <th>QR Operations</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-tbody">
                                        <!-- Employee rows will be inserted here -->
                                    </tbody>
                                </table>
                                <div class="no-employees" id="no-employees" style="display: none;">
                                    <i class="fas fa-user-tie"></i>
                                    <p>No employees registered yet</p>
                                    <button onclick="showEmployeeRegistration()" class="btn btn-primary">Register First Employee</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Tab -->
                        <div id="employee-performance-tab" class="tab-content">
                            <div class="performance-grid">
                                <div class="performance-card">
                                    <h4>Top Performers</h4>
                                    <div class="top-performers" id="top-performers">
                                        <!-- Top performers will be loaded here -->
                                    </div>
                                </div>
                                <div class="performance-card">
                                    <h4>QR Operations Summary</h4>
                                    <canvas id="employee-performance-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Activities Tab -->
                        <div id="employee-activities-tab" class="tab-content">
                            <div class="activities-filters">
                                <select id="employee-filter" onchange="filterEmployeeActivities()">
                                    <option value="">All Employees</option>
                                </select>
                                <select id="activity-type-filter" onchange="filterEmployeeActivities()">
                                    <option value="">All Activities</option>
                                    <option value="qr_create">QR Create</option>
                                    <option value="qr_scan">QR Scan</option>
                                    <option value="inventory_view">Inventory View</option>
                                    <option value="login">Login</option>
                                </select>
                            </div>
                            <div class="activities-list" id="employee-activities-list">
                                <!-- Activities will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Management Section -->
            <div id="attendance-management" class="section">
                <div class="attendance-container">
                    <div class="attendance-header">
                        <div class="header-content">
                            <h2>Attendance Management System</h2>
                            <p class="header-subtitle">Face recognition based attendance tracking and reporting</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn-export" onclick="exportAttendanceReport()">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                            <button class="btn-settings" onclick="showAttendanceSettings()">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                    </div>

                    <!-- Attendance Tabs -->
                    <div class="attendance-tabs">
                        <button class="tab-btn active" onclick="showAttendanceTab('registration')">
                            <i class="fas fa-user-plus"></i> Face Registration
                        </button>
                        <button class="tab-btn" onclick="showAttendanceTab('today')">
                            <i class="fas fa-calendar-day"></i> Today's Attendance
                        </button>
                        <button class="tab-btn" onclick="showAttendanceTab('reports')">
                            <i class="fas fa-chart-line"></i> Reports
                        </button>
                        <button class="tab-btn" onclick="showAttendanceTab('leaves')">
                            <i class="fas fa-calendar-times"></i> Leave Management
                        </button>
                    </div>

                    <!-- Face Registration Tab -->
                    <div id="registration-tab" class="tab-content active">
                        <div class="registration-container">
                            <div class="registration-form">
                                <h3>Register New Face</h3>
                                <form id="face-registration-form" enctype="multipart/form-data">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>User ID *</label>
                                            <input type="text" id="reg-user-id" required placeholder="e.g., EMP001">
                                        </div>
                                        <div class="form-group">
                                            <label>Full Name *</label>
                                            <input type="text" id="reg-user-name" required placeholder="Enter full name">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>User Type *</label>
                                            <select id="reg-user-type" required>
                                                <option value="">Select Type</option>
                                                <option value="employee">Employee</option>
                                                <option value="tailor">Tailor</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Department</label>
                                            <input type="text" id="reg-department" placeholder="e.g., Production">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Upload Face Photo *</label>
                                        <div class="photo-upload-area">
                                            <input type="file" id="face-photo" accept="image/*" required onchange="previewFacePhoto(event)">
                                            <div class="upload-placeholder" id="photo-preview">
                                                <i class="fas fa-camera"></i>
                                                <p>Click to upload photo or drag and drop</p>
                                                <span>JPG, PNG (Max 5MB)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn-secondary" onclick="resetRegistrationForm()">
                                            <i class="fas fa-redo"></i> Reset
                                        </button>
                                        <button type="submit" class="btn-primary">
                                            <i class="fas fa-save"></i> Register Face
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="registered-faces">
                                <h3>Registered Faces</h3>
                                <div class="search-bar">
                                    <input type="text" placeholder="Search by name or ID..." onkeyup="searchRegisteredFaces(this.value)">
                                </div>
                                <div class="faces-grid" id="registered-faces-grid">
                                    <!-- Registered faces will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Attendance Tab -->
                    <div id="today-tab" class="tab-content">
                        <div class="today-attendance">
                            <div class="attendance-stats">
                                <div class="stat-card">
                                    <div class="stat-icon present">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h4>Present</h4>
                                        <p class="stat-value" id="present-count">0</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon absent">
                                        <i class="fas fa-user-times"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h4>Absent</h4>
                                        <p class="stat-value" id="absent-count">0</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon late">
                                        <i class="fas fa-user-clock"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h4>Late</h4>
                                        <p class="stat-value" id="late-count">0</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon leave">
                                        <i class="fas fa-calendar-times"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h4>On Leave</h4>
                                        <p class="stat-value" id="leave-count">0</p>
                                    </div>
                                </div>
                            </div>

                            <div class="attendance-table-container">
                                <table class="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Check In</th>
                                            <th>Check Out</th>
                                            <th>Total Hours</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="today-attendance-tbody">
                                        <!-- Today's attendance records will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="reports-tab" class="tab-content">
                        <div class="attendance-reports">
                            <div class="report-filters">
                                <div class="filter-group">
                                    <label>From Date</label>
                                    <input type="date" id="report-from-date">
                                </div>
                                <div class="filter-group">
                                    <label>To Date</label>
                                    <input type="date" id="report-to-date">
                                </div>
                                <div class="filter-group">
                                    <label>User Type</label>
                                    <select id="report-user-type">
                                        <option value="">All</option>
                                        <option value="employee">Employees</option>
                                        <option value="tailor">Tailors</option>
                                    </select>
                                </div>
                                <button class="btn-primary" onclick="generateAttendanceReport()">
                                    <i class="fas fa-search"></i> Generate Report
                                </button>
                            </div>

                            <div class="report-summary" id="report-summary">
                                <!-- Report summary will be displayed here -->
                            </div>

                            <div class="report-table-container">
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>User ID</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Check In</th>
                                            <th>Check Out</th>
                                            <th>Hours</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-tbody">
                                        <!-- Report data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Leave Management Tab -->
                    <div id="leaves-tab" class="tab-content">
                        <div class="leave-management">
                            <div class="pending-leaves">
                                <h3>Pending Leave Requests</h3>
                                <div class="leave-requests" id="pending-leave-requests">
                                    <!-- Pending leave requests will be loaded here -->
                                </div>
                            </div>

                            <div class="leave-history">
                                <h3>Leave History</h3>
                                <div class="leave-table-container">
                                    <table class="leave-table">
                                        <thead>
                                            <tr>
                                                <th>Employee</th>
                                                <th>Type</th>
                                                <th>From</th>
                                                <th>To</th>
                                                <th>Days</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                                <th>Approved By</th>
                                            </tr>
                                        </thead>
                                        <tbody id="leave-history-tbody">
                                            <!-- Leave history will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="reports-container">
                    <div class="reports-header">
                        <div class="header-content">
                            <h2>Reports & Analytics</h2>
                            <p class="header-subtitle">Comprehensive insights and data analysis</p>
                        </div>
                        <!-- Reports controls removed -->
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <div class="metric-details">
                                <h3 id="total-value-metric">₹0</h3>
                                <p>Total Inventory Value</p>
                                <div class="metric-change" id="value-change">
                                    <span>Calculating...</span>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="metric-details">
                                <h3 id="total-products-metric">0</h3>
                                <p>Total Products</p>
                                <div class="metric-change" id="products-change">
                                    <span>Active items</span>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                                <i class="fas fa-trash-alt"></i>
                            </div>
                            <div class="metric-details">
                                <h3 id="deleted-items-metric">0</h3>
                                <p>Deleted Items</p>
                                <div class="metric-change" id="deleted-change">
                                    <span>Inactive products</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stock movements metric removed -->
                    </div>

                    <div class="charts-section">
                        <div class="charts-row">
                            <div class="chart-card large">
                                <div class="card-header">
                                    <h3>Stock Movement Trends</h3>
                                    <div class="chart-controls">
                                        <button class="chart-btn active" onclick="updateStockChart('line')">Line</button>
                                        <button class="chart-btn" onclick="updateStockChart('bar')">Bar</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="stockMovementChart"></canvas>
                                </div>
                            </div>

                            <div class="chart-card medium">
                                <div class="card-header">
                                    <h3>Category Distribution</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="charts-row">
                            <div class="chart-card medium">
                                <div class="card-header">
                                    <h3>Stock Status Overview</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="stockStatusChart"></canvas>
                                </div>
                            </div>

                            <div class="chart-card medium">
                                <div class="card-header">
                                    <h3>Top Products by Quantity</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="topProductsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed analytics section removed -->

                    <!-- AI insights section removed -->
                </div>
            </div>
        </main>

        <!-- Notification Container -->
        <div id="notification-container"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Original JavaScript functionality -->
    <script>
        // Global variables
        let html5QrCode;
        let currentTransactionsPage = 1;
        let transactionsPerPage = 50; // Default to 50 to match HTML select default
        let allTransactions = [];
        let filteredTransactions = [];

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
                if (sidebar.classList.contains('active')) {
                    mainContent.style.marginLeft = '0';
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                }
            }
        }

        // Collapse sidebar (shrink)
        function collapseSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const topHeader = document.querySelector('.top-header');
            
            sidebar.classList.toggle('collapsed');
            
            // Save state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            
            // Adjust main content and header
            if (isCollapsed) {
                if (mainContent) mainContent.style.marginLeft = '70px';
                if (topHeader) topHeader.style.left = '70px';
            } else {
                if (mainContent) mainContent.style.marginLeft = '250px';
                if (topHeader) topHeader.style.left = '250px';
            }
        }

        // Show section
        function showSection(sectionId, event) {
            if (event) {
                event.preventDefault();
            }
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show the target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            // Update page title in header
            const pageTitles = {
                'dashboard': 'Dashboard',
                'create-product': 'Create Product',
                'scan-qr': 'Scan QR Code',
                'inventory': 'Inventory Management',
                'transactions': 'Transaction History',
                'tailor-management': 'Tailor Management',
                'employee-management': 'Employee Management',
                'attendance-management': 'Attendance System',
                'reports': 'Reports & Analytics'
            };
            
            const currentPage = document.getElementById('current-page');
            if (currentPage) {
                currentPage.textContent = pageTitles[sectionId] || 'Dashboard';
            }
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                sidebar.classList.remove('active');
                document.body.style.overflow = 'auto';
            }

            // Initialize section-specific functionality
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'transactions') {
                // Only load if not already loaded
                if (allTransactions.length === 0) {
                    loadTransactions();
                } else {
                    displayTransactions();
                }
            } else if (sectionId === 'tailor-management') {
                if (typeof tailorManager === 'undefined') {
                    window.tailorManager = new TailorManagement();
                }
                tailorManager.init();
            } else if (sectionId === 'employee-management') {
                loadEmployees();
            } else if (sectionId === 'reports') {
                initReports();
            }
        }

        // QR Scanner functions
        function startScanner() {
            const scannerContainer = document.getElementById('scanner-container');
            const cameraInfo = document.getElementById('camera-info');
            const cameraLoading = document.getElementById('camera-loading');
            
            scannerContainer.style.display = 'block';
            cameraInfo.textContent = 'Initializing camera...';
            cameraLoading.style.display = 'block';

            html5QrCode = new Html5Qrcode("reader");
            
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id;
                    html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText, decodedResult) => {
                            onScanSuccess(decodedText);
                        },
                        (errorMessage) => {
                            // console.log(`QR Code scan error: ${errorMessage}`);
                        }
                    ).then(() => {
                        cameraInfo.textContent = 'Camera ready! Point at QR code to scan.';
                        cameraLoading.style.display = 'none';
                    }).catch(err => {
                        cameraInfo.textContent = 'Error starting camera: ' + err;
                        cameraLoading.style.display = 'none';
                    });
                }
            }).catch(err => {
                cameraInfo.textContent = 'No cameras found or permission denied.';
                cameraLoading.style.display = 'none';
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').style.display = 'none';
                    showNotification('Scanner stopped', 'info');
                });
            }
        }

        function showManualEntry() {
            document.getElementById('manual-entry').style.display = 'block';
        }

        function manualLookup() {
            const productId = document.getElementById('manual-product-id').value.trim();
            if (productId) {
                lookupProduct(productId);
            } else {
                showNotification('Please enter a product ID', 'warning');
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            lookupProduct(decodedText);
        }

        function lookupProduct(productId) {
            // Simulate API call to lookup product
            fetch(`/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Product not found');
                    }
                    return response.json();
                })
                .then(product => {
                    displayProductDetails(product);
                    document.getElementById('scan-result').style.display = 'block';
                    showNotification('Product found!', 'success');
                })
                .catch(error => {
                    showNotification('Product not found: ' + error.message, 'error');
                });
        }

        function displayProductDetails(product) {
            const detailsDiv = document.getElementById('product-details');
            detailsDiv.innerHTML = `
                <div class="product-card">
                    <h3>${product.name || 'Unknown Product'}</h3>
                    <p><strong>Product ID:</strong> ${product.id || product.product_id || 'N/A'}</p>
                    <p><strong>Current Stock:</strong> ${product.stock_quantity || 0} items</p>
                    <p><strong>Price:</strong> ₹${product.price || 0}</p>
                    <p><strong>Category:</strong> ${product.category || 'General'}</p>
                </div>
            `;
        }

        // Inventory action form submission
        document.addEventListener('DOMContentLoaded', function() {
            const inventoryForm = document.getElementById('inventory-action-form');
            if (inventoryForm) {
                inventoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const actionData = {
                        qr_data: document.getElementById('manual-product-id')?.value || 'scanned-product',
                        action: formData.get('action') || document.getElementById('action').value,
                        quantity: parseInt(formData.get('quantity') || document.getElementById('quantity').value),
                        performed_by: formData.get('performed_by') || document.getElementById('performed-by').value,
                        location: formData.get('location') || document.getElementById('location').value,
                        notes: formData.get('notes') || document.getElementById('notes').value
                    };

                    // Submit to API
                    fetch('/api/inventory/scan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(actionData)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            showNotification('Error: ' + result.error, 'error');
                        } else {
                            showNotification('Inventory updated successfully!', 'success');
                            this.reset();
                            document.getElementById('scan-result').style.display = 'none';
                            loadDashboardData(); // Refresh dashboard
                        }
                    })
                    .catch(error => {
                        showNotification('Network error: ' + error.message, 'error');
                    });
                });
            }
        });

        // Dashboard functions
        function loadDashboardData() {
            // Load dashboard statistics
            Promise.all([
                fetch('/api/dashboard/stats').catch(() => ({ ok: false })),
                fetch('/api/products').catch(() => ({ ok: false })),
                fetch('/api/transactions?limit=5').catch(() => ({ ok: false }))
            ]).then(responses => {
                responses.forEach((response, index) => {
                    if (response.ok) {
                        response.json().then(data => {
                            if (index === 0) updateDashboardStats(data);
                            else if (index === 1) updateProductStats(data);
                            else if (index === 2) updateRecentActivity(data);
                        });
                    }
                });
            });
        }

        function updateDashboardStats(stats) {
            if (stats) {
                document.getElementById('total-products').textContent = stats.totalProducts || 0;
                document.getElementById('total-items').textContent = stats.totalItems || 0;
                document.getElementById('product-types').textContent = stats.productTypes || 0;
                document.getElementById('recent-transactions').textContent = stats.recentTransactions || 0;
                document.getElementById('low-stock').textContent = stats.lowStock || 0;
            }
        }

        function updateProductStats(products) {
            if (Array.isArray(products)) {
                document.getElementById('total-products').textContent = products.length;
                const totalItems = products.reduce((sum, product) => sum + (product.stock_quantity || 0), 0);
                document.getElementById('total-items').textContent = totalItems;
                
                const categories = [...new Set(products.map(p => p.category || 'General'))];
                document.getElementById('product-types').textContent = categories.length;
                
                const lowStock = products.filter(p => (p.stock_quantity || 0) < 10).length;
                document.getElementById('low-stock').textContent = lowStock;
            }
        }

        // Real-time User Activity Tracking Functions
        let onlineUsers = [];
        let activityFeed = [];
        let productTracking = {};

        // Initialize real-time tracking
        function initializeRealtimeTracking() {
            loadOnlineUsers();
            loadLoginActivity(); 
            loadProductTracking();
            loadActivityFeed();
            
            // Set up real-time updates
            setInterval(checkOnlineUsers, 5000); // Check every 5 seconds for real-time updates
            setInterval(updateActivityFeed, 3000); // Update feed every 3 seconds
            
            // Listen for storage events for cross-tab communication
            window.addEventListener('storage', function(e) {
                if (e.key === 'userActivities' || e.key === 'onlineUsers' || e.key === 'productTracking') {
                    loadOnlineUsers();
                    loadLoginActivity();
                    loadActivityFeed();
                    loadProductTracking();
                }
            });
        }

        // Track activity using SessionManager
        function trackUserActivity(type, user, description) {
            SessionManager.logActivity(type, description, user);
            
            // Trigger update
            loadActivityFeed();
        }

        // Load online users from SessionManager
        function loadOnlineUsers() {
            // Get online users from SessionManager
            onlineUsers = SessionManager.getOnlineUsers();
            
            // Clean up old sessions
            SessionManager.cleanupOldSessions();
            
            updateOnlineUsersDisplay();
        }

        // Update online users display
        function updateOnlineUsersDisplay() {
            const container = document.getElementById('online-users');
            const count = document.getElementById('online-count');
            
            if (!container) return;
            
            count.textContent = onlineUsers.length;
            
            if (onlineUsers.length === 0) {
                container.innerHTML = '<div class="no-users">No users currently online</div>';
                return;
            }
            
            container.innerHTML = onlineUsers.map(user => `
                <div class="online-user-item">
                    <div class="user-info">
                        <div class="user-avatar">${(user.name || user.username || 'U').charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <span class="user-name">${user.name || user.username}</span>
                            <span class="user-role">${user.role}</span>
                        </div>
                    </div>
                    <div class="user-status">
                        <span class="login-time">${SessionManager.getTimeAgo(user.loginTime)}</span>
                        <span class="status-dot"></span>
                    </div>
                </div>
            `).join('');
        }

        // Load login activity from SessionManager
        function loadLoginActivity() {
            const activities = SessionManager.getActivities(20);
            const loginActivities = activities
                .filter(a => a.type === 'login' || a.type === 'logout')
                .slice(0, 10); // Last 10 login/logout activities
            
            const container = document.getElementById('login-activity');
            if (!container) return;
            
            if (loginActivities.length === 0) {
                container.innerHTML = '<div class="no-activity">No recent login activity</div>';
                return;
            }
            
            container.innerHTML = loginActivities.map(activity => {
                const isLogin = activity.type === 'login';
                return `
                    <div class="log-item ${isLogin ? 'login' : 'logout'}">
                        <i class="fas fa-${isLogin ? 'sign-in-alt' : 'sign-out-alt'} log-icon ${isLogin ? 'login' : 'logout'}"></i>
                        <div class="log-content">
                            <span class="log-user">${activity.user?.name || activity.user?.username || 'Unknown'}</span> ${activity.description}
                            <div class="log-time">${SessionManager.getTimeAgo(activity.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load product tracking data from SessionManager
        function loadProductTracking() {
            // Get product tracking from SessionManager
            const storedTracking = SessionManager.getProductTracking();
            const onlineUsersList = SessionManager.getOnlineUsers();
            
            // Update with online status
            Object.keys(storedTracking).forEach(userId => {
                const isOnline = onlineUsersList.some(u => u.id === userId);
                storedTracking[userId].isOnline = isOnline;
            });
            
            productTracking = storedTracking;
            updateProductTrackingDisplay();
        }
        
        // Track product addition
        function trackProductAddition(user, productCount = 1) {
            const userId = user.id || user.username;
            const userName = user.name || user.username;
            
            // Use SessionManager to track product addition
            SessionManager.trackProductAddition(userId, userName, productCount);
            
            // Update display
            loadProductTracking();
            loadActivityFeed();
        }

        // Update product tracking display
        function updateProductTrackingDisplay() {
            const tbody = document.getElementById('product-tracking-body');
            if (!tbody) return;
            
            const trackingData = Object.values(productTracking);
            
            if (trackingData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No product activity data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = trackingData.map(user => `
                <tr>
                    <td class="employee-name">${user.name}</td>
                    <td><span class="role-badge employee">Employee</span></td>
                    <td><span class="product-count">${user.todayProducts || 0}</span></td>
                    <td>${SessionManager.getTimeAgo(user.lastUpdate)}</td>
                    <td>
                        <span class="status-${user.isOnline ? 'online' : 'offline'}">
                            <i class="fas fa-circle"></i> ${user.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>
                        <button class="view-details-btn" onclick="viewUserDetails('${user.id}')">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update product tracking based on period
        function updateProductTracking(period) {
            // Simulate filtering by period
            console.log('Updating product tracking for period:', period);
            loadProductTracking(); // Reload with filtered data
        }

        // Load activity feed from SessionManager
        function loadActivityFeed() {
            activityFeed = SessionManager.getActivities(20);
            updateActivityFeedDisplay('all');
        }

        // Update activity feed display
        function updateActivityFeedDisplay(filter) {
            const container = document.getElementById('live-activity-feed');
            if (!container) return;
            
            let filteredFeed = activityFeed;
            if (filter !== 'all') {
                filteredFeed = activityFeed.filter(item => {
                    if (filter === 'login') return item.type === 'login';
                    if (filter === 'logout') return item.type === 'logout';
                    if (filter === 'products') return item.type === 'product';
                    return true;
                });
            }
            
            if (filteredFeed.length === 0) {
                container.innerHTML = '<div class="no-activity">No activity to display</div>';
                return;
            }
            
            container.innerHTML = filteredFeed.map(item => `
                <div class="feed-item">
                    <div class="feed-icon ${item.type === 'product' ? 'product' : item.type}">
                        <i class="fas fa-${item.type === 'login' ? 'sign-in-alt' : item.type === 'logout' ? 'sign-out-alt' : 'box'}"></i>
                    </div>
                    <div class="feed-content">
                        <div class="feed-title">${item.user?.name || item.user?.username || 'System'}</div>
                        <div class="feed-description">${item.description}</div>
                        <div class="feed-timestamp">${SessionManager.getTimeAgo(item.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Check online users and cleanup old sessions
        function checkOnlineUsers() {
            SessionManager.cleanupOldSessions();
            loadOnlineUsers();
        }

        // Update activity feed from SessionManager
        function updateActivityFeed() {
            loadActivityFeed();
        }

        // Clear login history
        function clearLoginHistory() {
            if (confirm('Are you sure you want to clear the login history?')) {
                document.getElementById('login-activity').innerHTML = '<div class="no-activity">Login history cleared</div>';
                showNotification('Login history cleared successfully', 'success');
            }
        }

        // View user details
        function viewUserDetails(userName) {
            showNotification(`Viewing details for ${userName}`, 'info');
            // This would open a modal or navigate to user details page
        }

        // Format time helper
        // Format time using SessionManager.getTimeAgo
        function formatTime(timestamp) {
            return SessionManager.getTimeAgo(timestamp);
        }

        // Initialize real-time tracking on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers for filter buttons
            setTimeout(() => {
                const filterButtons = document.querySelectorAll('.feed-controls .filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        filterButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        updateActivityFeedDisplay(this.dataset.filter);
                    });
                });
                
                // Initialize real-time tracking
                initializeRealtimeTracking();
            }, 1500);
        });

        function updateRecentActivity(transactions) {
            if (Array.isArray(transactions)) {
                document.getElementById('recent-transactions').textContent = transactions.length;
            }
        }



        function syncData() {
            showNotification('Syncing data...', 'info');
            setTimeout(() => {
                showNotification('Data synchronized!', 'success');
                loadDashboardData();
            }, 1500);
        }

        // Transaction functions
        function loadTransactions() {
            // First, try to fetch from API
            fetch('/api/transactions')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API not available');
                    }
                    return response.json();
                })
                .then(transactions => {
                    allTransactions = Array.isArray(transactions) ? transactions : [];
                    filteredTransactions = [...allTransactions];
                    updateTransactionsSummary();
                    displayTransactions();
                })
                .catch(error => {
                    console.log('Error loading transactions:', error);
                    allTransactions = [];
                    filteredTransactions = [];
                    updateTransactionsSummary();
                    displayTransactions();
                });
        }

        // Function to map transaction type to status label
        function getTransactionStatus(transactionType) {
            const statusMap = {
                'STOCK_IN': 'Stock In',
                'STOCK_OUT': 'Stock Out',
                'SALE': 'Removed',
                'INITIAL_STOCK': 'Updated',
                'UPDATE': 'Updated',
                'ADJUSTMENT': 'Updated'
            };
            return statusMap[transactionType] || transactionType;
        }

        function updateTransactionsSummary() {
            const total = filteredTransactions.length;
            const stockIn = filteredTransactions.filter(t => t.transaction_type === 'STOCK_IN' || t.transaction_type === 'INITIAL_STOCK').length;
            const stockOut = filteredTransactions.filter(t => t.transaction_type === 'STOCK_OUT' || t.transaction_type === 'SALE').length;

            // These elements don't exist in the current UI
            // document.getElementById('total-transactions').textContent = total;
            // document.getElementById('stock-in-count').textContent = stockIn;
            // document.getElementById('stock-out-count').textContent = stockOut;
            
            // Update the record count in header
            const recordCount = document.getElementById('trans-record-count');
            if (recordCount) {
                recordCount.textContent = `${total} Transactions`;
            }
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactions-list');
            const startIndex = (currentTransactionsPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            if (pageTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">No transactions found</td></tr>';
                // Don't show the empty state div since we have the message in the table
                const emptyState = document.querySelector('.empty-state.trans-empty');
                if (emptyState) emptyState.style.display = 'none';
                return;
            } else {
                const emptyState = document.querySelector('.empty-state.trans-empty');
                if (emptyState) emptyState.style.display = 'none';
            }

            tbody.innerHTML = pageTransactions.map((transaction, index) => {
                const transactionId = transaction.product_id || `PRD-${String(startIndex + index + 1).padStart(3, '0')}`;
                const date = new Date(transaction.created_at || Date.now());
                const actionType = transaction.transaction_type || 'STOCK_IN';
                const typeClass = actionType === 'STOCK_IN' || actionType === 'INITIAL_STOCK' ? 'type-in' : 
                                actionType === 'STOCK_OUT' || actionType === 'SALE' ? 'type-out' : 'type-sale';
                const qtyClass = actionType === 'STOCK_OUT' || actionType === 'SALE' ? 'negative' : 'positive';
                const qtySign = actionType === 'STOCK_OUT' || actionType === 'SALE' ? '-' : '+';
                
                return `
                    <tr>
                        <td class="trans-id">
                            <a href="#" class="link">${transactionId}</a>
                        </td>
                        <td class="timestamp">
                            <span class="date">${date.toLocaleDateString()}</span>
                            <span class="time">${date.toLocaleTimeString()}</span>
                        </td>
                        <td class="product-name">
                            <div class="name-cell">
                                <span class="name">${transaction.product_name || 'Unknown Product'}</span>
                                <span class="sub-info">ID: ${transaction.id || 'N/A'}</span>
                            </div>
                        </td>
                        <td class="trans-type">
                            <span class="type-badge ${typeClass}">
                                ${getTransactionStatus(actionType)}
                            </span>
                        </td>
                        <td class="size">${transaction.size || '-'}</td>
                        <td class="quantity">
                            <span class="qty-change ${qtyClass}">${qtySign}${Math.abs(transaction.quantity || 0)}</span>
                        </td>
                        <td class="user">${transaction.performed_by || 'System'}</td>
                        <td class="location">
                            <span class="location-badge">${transaction.location || 'Main'}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update record count
            const recordCount = document.getElementById('trans-record-count');
            if (recordCount) {
                recordCount.textContent = `${filteredTransactions.length} Transactions`;
            }
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            const startRecord = ((currentTransactionsPage - 1) * transactionsPerPage) + 1;
            const endRecord = Math.min(currentTransactionsPage * transactionsPerPage, filteredTransactions.length);
            
            // Update pagination info
            const transStart = document.getElementById('trans-start-record');
            const transEnd = document.getElementById('trans-end-record');
            const transTotal = document.getElementById('trans-total-records');
            
            if (transStart) transStart.textContent = filteredTransactions.length > 0 ? startRecord : 0;
            if (transEnd) transEnd.textContent = endRecord;
            if (transTotal) transTotal.textContent = filteredTransactions.length;
            
            // Update page buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn) prevBtn.disabled = currentTransactionsPage <= 1;
            if (nextBtn) nextBtn.disabled = currentTransactionsPage >= totalPages;
            
            // Generate and update page numbers dynamically
            const paginationDiv = document.querySelector('#transactions .pagination');
            if (paginationDiv && totalPages > 0) {
                // Keep prev button
                const prevBtn = paginationDiv.querySelector('#prev-btn');
                const nextBtn = paginationDiv.querySelector('#next-btn');
                
                // Clear existing page numbers
                const existingPageNumbers = paginationDiv.querySelectorAll('.page-number, .page-dots');
                existingPageNumbers.forEach(el => el.remove());
                
                // Generate new page numbers
                let pageButtonsHTML = '';
                
                if (totalPages <= 7) {
                    // Show all pages if 7 or less
                    for (let i = 1; i <= totalPages; i++) {
                        pageButtonsHTML += `<button class="page-number ${i === currentTransactionsPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                    }
                } else {
                    // Show first, last, and pages around current
                    if (currentTransactionsPage <= 3) {
                        for (let i = 1; i <= 5; i++) {
                            pageButtonsHTML += `<button class="page-number ${i === currentTransactionsPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                        }
                        pageButtonsHTML += `<span class="page-dots">...</span>`;
                        pageButtonsHTML += `<button class="page-number" onclick="goToPage(${totalPages})">${totalPages}</button>`;
                    } else if (currentTransactionsPage >= totalPages - 2) {
                        pageButtonsHTML += `<button class="page-number" onclick="goToPage(1)">1</button>`;
                        pageButtonsHTML += `<span class="page-dots">...</span>`;
                        for (let i = totalPages - 4; i <= totalPages; i++) {
                            pageButtonsHTML += `<button class="page-number ${i === currentTransactionsPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                        }
                    } else {
                        pageButtonsHTML += `<button class="page-number" onclick="goToPage(1)">1</button>`;
                        pageButtonsHTML += `<span class="page-dots">...</span>`;
                        for (let i = currentTransactionsPage - 1; i <= currentTransactionsPage + 1; i++) {
                            pageButtonsHTML += `<button class="page-number ${i === currentTransactionsPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                        }
                        pageButtonsHTML += `<span class="page-dots">...</span>`;
                        pageButtonsHTML += `<button class="page-number" onclick="goToPage(${totalPages})">${totalPages}</button>`;
                    }
                }
                
                // Insert page numbers between prev and next buttons
                if (nextBtn) {
                    nextBtn.insertAdjacentHTML('beforebegin', pageButtonsHTML);
                }
            }
            
            // Old pagination compatibility
            const currentPage = document.getElementById('current-page');
            const totalPagesEl = document.getElementById('total-pages');
            if (currentPage) currentPage.textContent = currentTransactionsPage;
            if (totalPagesEl) totalPagesEl.textContent = totalPages;
        }

        function previousPage() {
            if (currentTransactionsPage > 1) {
                currentTransactionsPage--;
                displayTransactions();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (currentTransactionsPage < totalPages) {
                currentTransactionsPage++;
                displayTransactions();
            }
        }
        
        function goToPage(pageNumber) {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentTransactionsPage = pageNumber;
                displayTransactions();
            }
        }

        function filterTransactions() {
            const dateFilter = document.getElementById('date-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchTerm = document.getElementById('search-transactions').value.toLowerCase();

            filteredTransactions = allTransactions.filter(transaction => {
                // Date filtering
                if (dateFilter !== 'all') {
                    const transactionDate = new Date(transaction.created_at || Date.now());
                    const today = new Date();
                    today.setHours(23, 59, 59, 999);
                    
                    switch (dateFilter) {
                        case 'today':
                            const todayStart = new Date();
                            todayStart.setHours(0, 0, 0, 0);
                            if (transactionDate < todayStart || transactionDate > today) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date();
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            weekAgo.setHours(0, 0, 0, 0);
                            if (transactionDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date();
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            monthAgo.setHours(0, 0, 0, 0);
                            if (transactionDate < monthAgo) return false;
                            break;
                        case 'year':
                            const yearAgo = new Date();
                            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                            yearAgo.setHours(0, 0, 0, 0);
                            if (transactionDate < yearAgo) return false;
                            break;
                    }
                }

                // Type/Status filtering
                if (typeFilter !== 'all' && transaction.transaction_type !== typeFilter) {
                    return false;
                }
                
                // Search filtering
                if (searchTerm && searchTerm !== '') {
                    const searchMatch = 
                        (transaction.product_name || '').toLowerCase().includes(searchTerm) ||
                        (transaction.product_id || '').toLowerCase().includes(searchTerm) ||
                        (transaction.performed_by || '').toLowerCase().includes(searchTerm) ||
                        (transaction.location || '').toLowerCase().includes(searchTerm) ||
                        (transaction.size || '').toLowerCase().includes(searchTerm);
                    
                    if (!searchMatch) return false;
                }

                return true;
            });

            currentTransactionsPage = 1;
            updateTransactionsSummary();
            displayTransactions();
            updateFilterIndicators();
        }

        function searchTransactions() {
            // Call the main filter function which now includes search
            filterTransactions();
        }
        
        function clearAllFilters() {
            // Reset all filter values
            document.getElementById('date-filter').value = 'all';
            document.getElementById('type-filter').value = 'all';
            document.getElementById('search-transactions').value = '';
            
            // Reset to show all transactions
            filteredTransactions = [...allTransactions];
            currentTransactionsPage = 1;
            
            // Update display
            updateTransactionsSummary();
            displayTransactions();
            updateFilterIndicators();
            
            // Visual feedback
            const btn = document.querySelector('.clear-filters-btn');
            if (btn) {
                btn.style.background = '#667eea';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.style.background = '';
                    btn.style.color = '';
                }, 300);
            }
        }
        
        function updateFilterIndicators() {
            const dateFilter = document.getElementById('date-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchTerm = document.getElementById('search-transactions').value;
            const clearBtn = document.querySelector('.clear-filters-btn');
            
            // Check if any filters are active
            const hasActiveFilters = dateFilter !== 'all' || typeFilter !== 'all' || searchTerm !== '';
            
            // Show/hide clear button based on active filters
            if (clearBtn) {
                clearBtn.style.display = hasActiveFilters ? 'flex' : 'none';
            }
            
            // Add active class to filter selects
            const dateSelect = document.getElementById('date-filter');
            const typeSelect = document.getElementById('type-filter');
            
            if (dateSelect) {
                if (dateFilter !== 'all') {
                    dateSelect.style.borderColor = '#667eea';
                    dateSelect.style.background = '#f0f4ff';
                } else {
                    dateSelect.style.borderColor = '';
                    dateSelect.style.background = '';
                }
            }
            
            if (typeSelect) {
                if (typeFilter !== 'all') {
                    typeSelect.style.borderColor = '#667eea';
                    typeSelect.style.background = '#f0f4ff';
                } else {
                    typeSelect.style.borderColor = '';
                    typeSelect.style.background = '';
                }
            }
        }

        
        // Add new function for updating transactions per page
        function updateTransPerPage() {
            const perPageSelect = document.getElementById('per-page-trans');
            if (perPageSelect) {
                transactionsPerPage = parseInt(perPageSelect.value);
                currentTransactionsPage = 1; // Reset to first page
                displayTransactions();
                updatePagination(); // Ensure pagination is updated
                
                // Optional: Add visual feedback
                perPageSelect.style.borderColor = '#667eea';
                setTimeout(() => {
                    perPageSelect.style.borderColor = '';
                }, 300);
            }
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,Product,Action,Quantity,Date,Performed By,Location\n" +
                filteredTransactions.map(t => 
                    `${t.id || 'N/A'},${t.product_name || 'Unknown'},${t.action || 'N/A'},${t.quantity || 0},${new Date(t.created_at || Date.now()).toLocaleString()},${t.performed_by || 'System'},${t.location || 'N/A'}`
                ).join("\n");

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `transactions-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Transactions exported successfully!', 'success');
        }

        // Tailor Management functions
        let tailors = [];

        function loadTailors() {
            fetch('/api/tailor/all')
                .then(response => response.json())
                .then(data => {
                    tailors = Array.isArray(data) ? data : [];
                    
                    // Store tailors in localStorage for login detection
                    const tailorsList = tailors.map(t => ({
                        username: t.username,
                        name: t.name,
                        role: 'tailor'
                    }));
                    localStorage.setItem('tailorsList', JSON.stringify(tailorsList));
                    
                    updateTailorStats();
                    displayTailors();
                })
                .catch(error => {
                    console.error('Error loading tailors:', error);
                    tailors = [];
                });
        }

        function updateTailorStats() {
            document.getElementById('total-tailors').textContent = tailors.length;
            document.getElementById('active-orders').textContent = Math.floor(tailors.length * 2.5); // Placeholder
            document.getElementById('avg-rating').textContent = '4.8'; // Placeholder
        }

        function displayTailors() {
            const tbody = document.getElementById('tailors-table-body');
            
            if (tailors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No tailors found.</td></tr>';
                return;
            }

            tbody.innerHTML = tailors.map(tailor => `
                <tr>
                    <td>
                        <div class="tailor-info">
                            <strong>${tailor.name || 'Unknown'}</strong>
                            <small>ID: ${tailor.id || 'N/A'}</small>
                        </div>
                    </td>
                    <td>
                        <div class="contact-info">
                            <div>${tailor.phone || 'N/A'}</div>
                            <small>${tailor.email || 'N/A'}</small>
                        </div>
                    </td>
                    <td>${tailor.specialty || 'General'}</td>
                    <td>${tailor.experience || 0} years</td>
                    <td>₹${tailor.rate || 0}/hr</td>
                    <td><span class="status-badge active">Active</span></td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editTailor('${tailor.id}')" class="btn-icon" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTailor('${tailor.id}')" class="btn-icon" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function addTailor(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const tailorData = Object.fromEntries(formData);
            
            // Map form fields to API expected fields
            const apiData = {
                name: tailorData.name,
                username: tailorData.username,
                password: tailorData.password,
                email: tailorData.email,
                phone: tailorData.phone,
                address: tailorData.address,
                specialization: tailorData.specialty,
                experience_years: parseInt(tailorData.experience) || 0
            };

            fetch('/api/tailor/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showNotification('Error: ' + result.error, 'error');
                } else {
                    // Store tailor in localStorage for login detection
                    const tailors = JSON.parse(localStorage.getItem('tailorsList') || '[]');
                    tailors.push({
                        username: tailorData.username,
                        name: tailorData.name,
                        role: 'tailor'
                    });
                    localStorage.setItem('tailorsList', JSON.stringify(tailors));
                    
                    showNotification(
                        `Tailor registered successfully! Login credentials - Username: ${result.credentials.username}, Password: ${result.credentials.password}`, 
                        'success'
                    );
                    event.target.reset();
                    loadTailors();
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }

        function editTailor(tailorId) {
            showNotification('Edit functionality coming soon', 'info');
        }

        function deleteTailor(tailorId) {
            if (confirm('Are you sure you want to delete this tailor?')) {
                fetch(`/api/tailor/${tailorId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        showNotification('Error: ' + result.error, 'error');
                    } else {
                        showNotification('Tailor deleted successfully!', 'success');
                        loadTailors();
                    }
                })
                .catch(error => {
                    showNotification('Network error: ' + error.message, 'error');
                });
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modern-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

            // Update tab content
            document.querySelectorAll('.modern-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabContent = document.getElementById(`${tabName}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
                
                // Load data based on tab
                if (tabName === 'assignments') {
                    loadAssignments();
                    loadTailorsForSelect();
                } else if (tabName === 'notifications') {
                    loadNotifications();
                    loadTailorsForSelect('notification-tailor');
                }
            }
        }

        // Generate random password
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%';
            let password = '';
            for (let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('tailor-password').value = password;
        }

        // Load tailors for select dropdown
        function loadTailorsForSelect(selectId = 'assignment-tailor') {
            fetch('/api/tailor/all')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(selectId);
                    const currentValue = select.value;
                    
                    // Clear existing options except first
                    while (select.options.length > (selectId === 'notification-tailor' ? 2 : 1)) {
                        select.remove(select.options.length - 1);
                    }
                    
                    // Add tailor options
                    data.forEach(tailor => {
                        const option = document.createElement('option');
                        option.value = tailor.tailor_id;
                        option.textContent = `${tailor.name} - ${tailor.specialization || 'General'}`;
                        select.appendChild(option);
                    });
                    
                    if (currentValue) select.value = currentValue;
                })
                .catch(error => console.error('Error loading tailors:', error));
        }

        // Create assignment
        function createAssignment(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const assignmentData = Object.fromEntries(formData);

            fetch('/api/tailor/assignments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(assignmentData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showNotification('Error: ' + result.error, 'error');
                } else {
                    showNotification('Assignment created successfully!', 'success');
                    event.target.reset();
                    loadAssignments();
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }

        // Load assignments
        function loadAssignments() {
            fetch('/api/tailor/assignments')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('assignments-list');
                    
                    if (!data || data.length === 0) {
                        container.innerHTML = '<p class="no-data">No assignments found</p>';
                        return;
                    }
                    
                    container.innerHTML = data.map(assignment => `
                        <div class="assignment-card">
                            <div class="assignment-header">
                                <h4>${assignment.title || assignment.garment_type}</h4>
                                <span class="badge badge-${assignment.priority || 'normal'}">${assignment.priority || 'Normal'}</span>
                            </div>
                            <div class="assignment-details">
                                <p><i class="fas fa-user"></i> ${assignment.tailor_name}</p>
                                <p><i class="fas fa-calendar"></i> Deadline: ${new Date(assignment.expected_date || assignment.deadline).toLocaleDateString()}</p>
                                <p><i class="fas fa-sort-numeric-up"></i> Quantity: ${assignment.quantity}</p>
                                <p><i class="fas fa-info-circle"></i> Status: ${assignment.status}</p>
                            </div>
                            <div class="assignment-actions">
                                <button class="btn btn-sm" onclick="updateAssignmentStatus('${assignment.assignment_id}', 'completed')">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="viewAssignment('${assignment.assignment_id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading assignments:', error);
                    document.getElementById('assignments-list').innerHTML = '<p class="error">Error loading assignments</p>';
                });
        }

        // Filter assignments
        function filterAssignments() {
            const status = document.getElementById('assignment-filter').value;
            const url = status ? `/api/tailor/assignments?status=${status}` : '/api/tailor/assignments';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('assignments-list');
                    // Reuse the display logic from loadAssignments
                    if (!data || data.length === 0) {
                        container.innerHTML = '<p class="no-data">No assignments found</p>';
                        return;
                    }
                    // ... display assignments
                })
                .catch(error => console.error('Error filtering assignments:', error));
        }

        // Send notification
        function sendNotification(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const notificationData = Object.fromEntries(formData);
            
            if (notificationData.tailor_id === 'all') {
                // Send to all tailors
                fetch('/api/tailor')
                    .then(response => response.json())
                    .then(tailors => {
                        const promises = tailors.map(tailor => 
                            fetch('/api/tailor/notifications', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    ...notificationData,
                                    tailor_id: tailor.tailor_id
                                })
                            })
                        );
                        return Promise.all(promises);
                    })
                    .then(() => {
                        showNotification('Notification sent to all tailors!', 'success');
                        event.target.reset();
                        loadNotifications();
                    })
                    .catch(error => {
                        showNotification('Error sending notifications: ' + error.message, 'error');
                    });
            } else {
                fetch('/api/tailor/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notificationData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        showNotification('Error: ' + result.error, 'error');
                    } else {
                        showNotification('Notification sent successfully!', 'success');
                        event.target.reset();
                        loadNotifications();
                    }
                })
                .catch(error => {
                    showNotification('Network error: ' + error.message, 'error');
                });
            }
        }

        // Load recent notifications
        function loadNotifications() {
            // This would typically fetch all notifications, but for now we'll show a placeholder
            const container = document.getElementById('notifications-history');
            container.innerHTML = `
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="notification-content">
                        <h5>System Update</h5>
                        <p>New features have been added to the tailor management system.</p>
                        <span class="notification-time">5 minutes ago</span>
                    </div>
                </div>
            `;
        }

        // Update assignment status
        function updateAssignmentStatus(assignmentId, status) {
            fetch(`/api/tailor/assignments/${assignmentId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('Assignment updated successfully!', 'success');
                    loadAssignments();
                } else {
                    showNotification('Error updating assignment', 'error');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }

        // View assignment details
        function viewAssignment(assignmentId) {
            showNotification('Opening assignment details...', 'info');
            // This could open a modal or navigate to a detail page
        }

        function searchTailors() {
            const searchTerm = document.getElementById('tailor-search').value.toLowerCase();
            const rows = document.querySelectorAll('#tailors-table-body tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterTailors() {
            const specialty = document.getElementById('specialty-filter').value;
            const rows = document.querySelectorAll('#tailors-table-body tr');

            rows.forEach(row => {
                if (specialty === '' || row.textContent.includes(specialty)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function importTailors() {
            showNotification('Import functionality coming soon', 'info');
        }

        // Attendance Management functions
        let registeredFaces = [];
        let todayAttendance = [];
        let currentAttendanceTab = 'registration';

        // Tab switching
        function showAttendanceTab(tabName) {
            currentAttendanceTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.attendance-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load data for the selected tab
            switch(tabName) {
                case 'registration':
                    loadRegisteredFaces();
                    break;
                case 'today':
                    loadTodayAttendance();
                    break;
                case 'reports':
                    // Reports loaded on demand
                    break;
                case 'leaves':
                    loadLeaveRequests();
                    break;
            }
        }

        // Face Registration
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('face-registration-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await registerFace();
                });
            }
        });

        async function registerFace() {
            const formData = new FormData();
            const fileInput = document.getElementById('face-photo');
            const userId = document.getElementById('reg-user-id').value;
            const userName = document.getElementById('reg-user-name').value;
            const userType = document.getElementById('reg-user-type').value;
            
            if (!fileInput.files[0]) {
                showNotification('Please select a photo', 'error');
                return;
            }
            
            formData.append('face_photo', fileInput.files[0]);
            formData.append('user_id', userId);
            formData.append('user_name', userName);
            formData.append('user_type', userType);
            
            try {
                const response = await fetch('/api/attendance/register-face', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Face registered successfully!', 'success');
                    resetRegistrationForm();
                    loadRegisteredFaces();
                } else {
                    showNotification(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Failed to register face', 'error');
            }
        }

        function previewFacePhoto(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('photo-preview');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="photo-preview-img" alt="Preview">`;
                    preview.classList.add('has-preview');
                };
                reader.readAsDataURL(file);
            }
        }

        function resetRegistrationForm() {
            document.getElementById('face-registration-form').reset();
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = `
                <i class="fas fa-camera"></i>
                <p>Click to upload photo or drag and drop</p>
                <span>JPG, PNG (Max 5MB)</span>
            `;
            preview.classList.remove('has-preview');
        }

        async function loadRegisteredFaces() {
            try {
                const response = await fetch('/api/attendance/registered-faces');
                const faces = await response.json();
                registeredFaces = faces;
                displayRegisteredFaces();
            } catch (error) {
                console.error('Error loading registered faces:', error);
            }
        }

        function displayRegisteredFaces() {
            const grid = document.getElementById('registered-faces-grid');
            if (!grid) return;
            
            if (registeredFaces.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999;">No registered faces yet</p>';
                return;
            }
            
            grid.innerHTML = registeredFaces.map(face => `
                <div class="face-card">
                    <img src="${face.photo_path || '/assets/images/default-avatar.png'}" alt="${face.user_name}">
                    <div class="name">${face.user_name}</div>
                    <div class="id">${face.user_id}</div>
                </div>
            `).join('');
        }

        function searchRegisteredFaces(query) {
            const filtered = registeredFaces.filter(face => 
                face.user_name.toLowerCase().includes(query.toLowerCase()) ||
                face.user_id.toLowerCase().includes(query.toLowerCase())
            );
            
            const grid = document.getElementById('registered-faces-grid');
            if (filtered.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999;">No matching faces found</p>';
                return;
            }
            
            grid.innerHTML = filtered.map(face => `
                <div class="face-card">
                    <img src="${face.photo_path || '/assets/images/default-avatar.png'}" alt="${face.user_name}">
                    <div class="name">${face.user_name}</div>
                    <div class="id">${face.user_id}</div>
                </div>
            `).join('');
        }

        // Today's Attendance
        async function loadTodayAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/attendance/records?start_date=${today}&end_date=${today}`);
                const records = await response.json();
                todayAttendance = records;
                displayTodayAttendance();
                updateAttendanceStats();
            } catch (error) {
                console.error('Error loading today attendance:', error);
            }
        }

        function displayTodayAttendance() {
            const tbody = document.getElementById('today-attendance-tbody');
            if (!tbody) return;
            
            if (todayAttendance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No attendance records for today</td></tr>';
                return;
            }
            
            tbody.innerHTML = todayAttendance.map(record => `
                <tr>
                    <td>${record.user_id}</td>
                    <td>${record.user_name}</td>
                    <td>${record.user_type}</td>
                    <td>${formatTime(record.check_in_time)}</td>
                    <td>${record.check_out_time ? formatTime(record.check_out_time) : '-'}</td>
                    <td>${record.total_hours || '-'}</td>
                    <td><span class="status-badge ${record.status}">${record.status}</span></td>
                    <td>
                        ${!record.check_out_time ? 
                            `<button class="btn-sm btn-primary" onclick="markCheckOut('${record.user_id}')">
                                <i class="fas fa-sign-out-alt"></i> Check Out
                            </button>` : 
                            '<span style="color: #999;">Completed</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        function updateAttendanceStats() {
            const stats = {
                present: 0,
                absent: 0,
                late: 0,
                leave: 0
            };
            
            todayAttendance.forEach(record => {
                if (record.status === 'present') stats.present++;
                else if (record.status === 'late') stats.late++;
                else if (record.status === 'leave') stats.leave++;
            });
            
            // Calculate absent (registered faces - present - late - leave)
            stats.absent = registeredFaces.length - stats.present - stats.late - stats.leave;
            
            document.getElementById('present-count').textContent = stats.present;
            document.getElementById('absent-count').textContent = stats.absent;
            document.getElementById('late-count').textContent = stats.late;
            document.getElementById('leave-count').textContent = stats.leave;
        }

        // Attendance Reports
        async function generateAttendanceReport() {
            const fromDate = document.getElementById('report-from-date').value;
            const toDate = document.getElementById('report-to-date').value;
            const userType = document.getElementById('report-user-type').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select date range', 'error');
                return;
            }
            
            try {
                let url = `/api/attendance/records?start_date=${fromDate}&end_date=${toDate}`;
                if (userType) url += `&user_type=${userType}`;
                
                const response = await fetch(url);
                const records = await response.json();
                displayAttendanceReport(records);
                generateReportSummary(records);
            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Failed to generate report', 'error');
            }
        }

        function displayAttendanceReport(records) {
            const tbody = document.getElementById('report-tbody');
            if (!tbody) return;
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No records found for the selected period</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${formatDate(record.date)}</td>
                    <td>${record.user_id}</td>
                    <td>${record.user_name}</td>
                    <td>${record.user_type}</td>
                    <td>${formatTime(record.check_in_time)}</td>
                    <td>${record.check_out_time ? formatTime(record.check_out_time) : '-'}</td>
                    <td>${record.total_hours || '-'}</td>
                    <td><span class="status-badge ${record.status}">${record.status}</span></td>
                </tr>
            `).join('');
        }

        function generateReportSummary(records) {
            const summary = document.getElementById('report-summary');
            if (!summary) return;
            
            const stats = {
                totalDays: new Set(records.map(r => r.date)).size,
                totalRecords: records.length,
                present: records.filter(r => r.status === 'present').length,
                late: records.filter(r => r.status === 'late').length,
                halfDay: records.filter(r => r.status === 'half-day').length,
                totalHours: records.reduce((sum, r) => sum + (r.total_hours || 0), 0)
            };
            
            summary.innerHTML = `
                <div class="report-summary-content">
                    <h4>Report Summary</h4>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span>Total Days:</span>
                            <strong>${stats.totalDays}</strong>
                        </div>
                        <div class="summary-stat">
                            <span>Total Records:</span>
                            <strong>${stats.totalRecords}</strong>
                        </div>
                        <div class="summary-stat">
                            <span>Present:</span>
                            <strong>${stats.present}</strong>
                        </div>
                        <div class="summary-stat">
                            <span>Late:</span>
                            <strong>${stats.late}</strong>
                        </div>
                        <div class="summary-stat">
                            <span>Half Day:</span>
                            <strong>${stats.halfDay}</strong>
                        </div>
                        <div class="summary-stat">
                            <span>Total Hours:</span>
                            <strong>${stats.totalHours.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        async function exportAttendanceReport() {
            const fromDate = document.getElementById('report-from-date')?.value || '';
            const toDate = document.getElementById('report-to-date')?.value || '';
            const userType = document.getElementById('report-user-type')?.value || '';
            
            if (!fromDate || !toDate) {
                // Use current month if no dates selected
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                
                window.location.href = `/api/attendance/export?start_date=${firstDay}&end_date=${lastDay}&user_type=${userType}`;
            } else {
                window.location.href = `/api/attendance/export?start_date=${fromDate}&end_date=${toDate}&user_type=${userType}`;
            }
        }

        // Leave Management
        async function loadLeaveRequests() {
            try {
                const response = await fetch('/api/attendance/leave-requests/pending');
                const requests = await response.json();
                displayPendingLeaves(requests);
                loadLeaveHistory();
            } catch (error) {
                console.error('Error loading leave requests:', error);
            }
        }

        function displayPendingLeaves(requests) {
            const container = document.getElementById('pending-leave-requests');
            if (!container) return;
            
            if (requests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No pending leave requests</p>';
                return;
            }
            
            container.innerHTML = requests.map(request => `
                <div class="leave-request-card">
                    <div class="leave-request-header">
                        <div class="leave-request-info">
                            <h4>${request.user_name || request.user_id}</h4>
                            <p>${request.leave_type} - ${formatDate(request.from_date)} to ${formatDate(request.to_date)}</p>
                            <p style="margin-top: 10px;">${request.reason || 'No reason provided'}</p>
                        </div>
                        <div class="leave-request-actions">
                            <button class="btn-approve" onclick="handleLeaveRequest(${request.id}, 'approved')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn-reject" onclick="handleLeaveRequest(${request.id}, 'rejected')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function handleLeaveRequest(leaveId, status) {
            const currentUser = SessionManager.getCurrentUser();
            const approvedBy = currentUser ? currentUser.name : 'Admin';
            
            try {
                const response = await fetch(`/api/attendance/leave-request/${leaveId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        approved_by: approvedBy
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Leave request ${status}`, 'success');
                    loadLeaveRequests();
                } else {
                    showNotification('Failed to update leave request', 'error');
                }
            } catch (error) {
                console.error('Error updating leave request:', error);
                showNotification('Failed to update leave request', 'error');
            }
        }

        async function loadLeaveHistory() {
            // This would load approved/rejected leave history
            // Implementation depends on backend API
        }

        function showAttendanceSettings() {
            // Open attendance settings modal
            showNotification('Settings functionality coming soon', 'info');
        }

        // Utility functions for attendance
        function formatTime(datetime) {
            if (!datetime) return '-';
            const date = new Date(datetime);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Employee Management functions
        let employees = [];
        
        function loadEmployees() {
            fetch('/api/employee/all')
                .then(response => response.json())
                .then(data => {
                    employees = Array.isArray(data) ? data : [];
                    updateEmployeeStats();
                    displayEmployees();
                    populateEmployeeFilters();
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    showNotification('Error loading employees', 'error');
                });
        }
        
        function updateEmployeeStats() {
            const totalEmployees = employees.length;
            const activeEmployees = employees.filter(emp => emp.status === 'active').length;
            
            document.getElementById('total-employees').textContent = activeEmployees;
            
            // Get today's QR operations count (this would need to be calculated from activities)
            document.getElementById('employee-qr-today').textContent = '0'; // Placeholder
            document.getElementById('pending-notifications').textContent = '0'; // Placeholder
        }
        
        function displayEmployees() {
            const tbody = document.getElementById('employees-tbody');
            const noEmployees = document.getElementById('no-employees');
            
            if (employees.length === 0) {
                document.getElementById('employees-table').style.display = 'none';
                noEmployees.style.display = 'block';
                return;
            }
            
            document.getElementById('employees-table').style.display = 'table';
            noEmployees.style.display = 'none';
            
            tbody.innerHTML = employees.map(employee => `
                <tr>
                    <td><span class="employee-id">${employee.employee_id}</span></td>
                    <td>
                        <div class="employee-info">
                            <div class="employee-name">${employee.name}</div>
                            <div class="employee-email">${employee.email || 'N/A'}</div>
                        </div>
                    </td>
                    <td>${employee.department || 'N/A'}</td>
                    <td>${employee.phone || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${employee.status}">${employee.status}</span>
                    </td>
                    <td>
                        <div class="qr-operations">
                            <span class="qr-count">0</span> operations
                        </div>
                    </td>
                    <td>${employee.last_login ? new Date(employee.last_login).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <div class="employee-actions">
                            <button onclick="viewEmployeeDetails('${employee.employee_id}')" class="btn-icon" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="sendNotificationToEmployee('${employee.employee_id}')" class="btn-icon" title="Send Notification">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button onclick="toggleEmployeeStatus('${employee.employee_id}')" class="btn-icon" title="Toggle Status">
                                <i class="fas fa-toggle-${employee.status === 'active' ? 'on' : 'off'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function showEmployeeRegistration() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>Register New Employee</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="registerEmployee(event)" class="employee-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" name="name" required placeholder="Enter employee name">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" name="email" placeholder="employee@company.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" name="phone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <select name="department">
                                    <option value="">Select Department</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Inventory">Inventory</option>
                                    <option value="Quality Control">Quality Control</option>
                                    <option value="Shipping">Shipping</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" name="username" required placeholder="Unique username">
                            </div>
                            <div class="form-group">
                                <label>Password *</label>
                                <div class="password-input">
                                    <input type="password" name="password" required id="employee-password" placeholder="Auto-generated">
                                    <button type="button" onclick="generateEmployeePassword()" class="btn-generate">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus"></i> Register Employee
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            generateEmployeePassword(); // Auto-generate initial password
        }
        
        function generateEmployeePassword() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('employee-password').value = password;
        }
        
        function registerEmployee(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const employeeData = Object.fromEntries(formData);
            
            fetch('/api/employee/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(employeeData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(`Employee registered successfully! Employee ID: ${result.employee_id}`, 'success');
                    event.target.closest('.modal-overlay').remove();
                    loadEmployees();
                } else {
                    showNotification('Error: ' + result.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }
        
        function showNotificationModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>Send Notification</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form onsubmit="sendNotification(event)" class="notification-form">
                        <div class="form-group">
                            <label>Send To</label>
                            <select name="employee_id" id="notification-employee">
                                <option value="">All Employees</option>
                                ${employees.map(emp => `<option value="${emp.employee_id}">${emp.name} (${emp.employee_id})</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select name="type">
                                <option value="info">Information</option>
                                <option value="task">Task</option>
                                <option value="reminder">Reminder</option>
                                <option value="urgent">Urgent</option>
                                <option value="system">System</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Title *</label>
                            <input type="text" name="title" required placeholder="Notification title">
                        </div>
                        <div class="form-group">
                            <label>Message *</label>
                            <textarea name="message" required placeholder="Enter your message here..." rows="4"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function sendNotification(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const notificationData = Object.fromEntries(formData);
            
            fetch('/api/employee/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notificationData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const target = notificationData.employee_id ? 'employee' : 'all employees';
                    showNotification(`Notification sent to ${target} successfully!`, 'success');
                    event.target.closest('.modal-overlay').remove();
                } else {
                    showNotification('Error: ' + result.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Network error: ' + error.message, 'error');
            });
        }
        
        function showEmployeeTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`employee-${tabName}-tab`).classList.add('active');
            
            // Load data based on tab
            if (tabName === 'activities') {
                loadEmployeeActivities();
            } else if (tabName === 'performance') {
                loadEmployeePerformance();
            }
        }
        
        function loadEmployeeActivities() {
            // This would load recent employee activities
            const activitiesList = document.getElementById('employee-activities-list');
            activitiesList.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #9ca3af;">
                    <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <p>Employee activities will be loaded here</p>
                </div>
            `;
        }
        
        function loadEmployeePerformance() {
            // This would load employee performance data
            const topPerformers = document.getElementById('top-performers');
            topPerformers.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #9ca3af;">
                    <p>Performance data will be loaded here</p>
                </div>
            `;
        }
        
        function populateEmployeeFilters() {
            const employeeFilter = document.getElementById('employee-filter');
            employeeFilter.innerHTML = '<option value="">All Employees</option>' + 
                employees.map(emp => `<option value="${emp.employee_id}">${emp.name}</option>`).join('');
        }
        
        
        function viewEmployeeDetails(employeeId) {
            const employee = employees.find(emp => emp.employee_id === employeeId);
            if (!employee) return;
            
            showNotification(`Employee details for ${employee.name} - Feature coming soon!`, 'info');
        }
        
        function sendNotificationToEmployee(employeeId) {
            // Pre-fill the notification form with this specific employee
            showNotificationModal();
            setTimeout(() => {
                const select = document.getElementById('notification-employee');
                if (select) select.value = employeeId;
            }, 100);
        }
        
        function toggleEmployeeStatus(employeeId) {
            const employee = employees.find(emp => emp.employee_id === employeeId);
            if (!employee) return;
            
            const newStatus = employee.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} ${employee.name}?`)) {
                // This would call an API to update employee status
                showNotification(`Employee status toggle - Feature coming soon!`, 'info');
            }
        }
        
        function filterEmployeeActivities() {
            // This would filter the activities based on selected filters
            showNotification('Activity filtering - Feature coming soon!', 'info');
        }

        // Reports functions with real data
        let reportCharts = {};
        
        async function initReports() {
            try {
                // Fetch real report data
                const response = await fetch('/api/reports/summary');
                const reportData = await response.json();
                
                // Update metrics
                updateReportsMetrics(reportData);
                
                // Create charts
                createReportCharts(reportData);
                
                showNotification('Reports loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading reports:', error);
                showNotification('Error loading reports', 'error');
                // Fallback to sample data
                updateReportsMetricsFallback();
            }
        }

        function updateReportsMetrics(data) {
            // Update product metrics
            if (data.products) {
                document.getElementById('total-value-metric').textContent = '₹' + (data.products.total_value || 0).toFixed(0);
                document.getElementById('total-products-metric').textContent = data.products.total_products || 0;
                document.getElementById('deleted-items-metric').textContent = data.products.deleted_products || 0;
                
                // Update change indicators
                document.getElementById('value-change').innerHTML = `<span style="color: #059669">${data.products.total_items || 0} items in stock</span>`;
                document.getElementById('products-change').innerHTML = `<span>${data.products.out_of_stock || 0} out of stock</span>`;
                document.getElementById('deleted-change').innerHTML = `<span style="color: #dc2626">${data.products.deleted_products || 0} removed</span>`;
            }
            
            // Transaction metrics removed - stock movements metric no longer displayed
        }
        
        function updateReportsMetricsFallback() {
            // Fallback with sample data
            document.getElementById('total-value-metric').textContent = '₹0';
            document.getElementById('total-products-metric').textContent = '0';
            document.getElementById('deleted-items-metric').textContent = '0';
        }
        
        function createReportCharts(data) {
            // Destroy existing charts if any
            Object.values(reportCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Create Stock Movement Chart
            createStockMovementChart(data.daily_activity || []);
            
            // Create Category Distribution Chart
            createCategoryChart(data.categories || []);
            
            // Create Stock Status Chart
            createStockStatusChart(data.products || {});
            
            // Create Top Products Chart
            createTopProductsChart(data.top_products || []);
        }
        
        function createStockMovementChart(activityData) {
            const ctx = document.getElementById('stockMovementChart').getContext('2d');
            
            // Generate last 30 days of dates if no data
            const generateLast30Days = () => {
                const dates = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                return dates;
            };
            
            const labels = activityData.length > 0 
                ? activityData.map(d => d.date ? new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '')
                : generateLast30Days();
                
            const stockIn = activityData.length > 0 
                ? activityData.map(d => d.stock_in || 0)
                : Array(30).fill(0).map(() => Math.floor(Math.random() * 50) + 10);
                
            const stockOut = activityData.length > 0 
                ? activityData.map(d => d.stock_out || 0)
                : Array(30).fill(0).map(() => Math.floor(Math.random() * 40) + 5);
            
            reportCharts.stockMovement = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock In',
                        data: stockIn,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(34, 197, 94)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: 'rgb(34, 197, 94)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }, {
                        label: 'Stock Out',
                        data: stockOut,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(239, 68, 68)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: 'rgb(239, 68, 68)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' items';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value + ' items';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createCategoryChart(categories) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const labels = categories.map(c => c.category || 'Unknown');
            const quantities = categories.map(c => c.total_quantity || 0);
            
            reportCharts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ['Shirts', 'Pants', 'Jackets', 'Others'],
                    datasets: [{
                        data: quantities.length ? quantities : [45, 30, 15, 10],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }
        
        function createStockStatusChart(productStats) {
            const ctx = document.getElementById('stockStatusChart').getContext('2d');
            
            const inStock = (productStats.total_products || 0) - (productStats.out_of_stock || 0) - (productStats.low_stock || 0);
            
            reportCharts.stockStatus = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                    datasets: [{
                        data: [inStock, productStats.low_stock || 0, productStats.out_of_stock || 0],
                        backgroundColor: [
                            '#059669',
                            '#f59e0b',
                            '#dc2626'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        function createTopProductsChart(topProducts) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            const labels = topProducts.slice(0, 5).map(p => p.name || 'Unknown');
            const quantities = topProducts.slice(0, 5).map(p => p.quantity || 0);
            
            reportCharts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length ? labels : ['Product 1', 'Product 2', 'Product 3', 'Product 4', 'Product 5'],
                    datasets: [{
                        label: 'Quantity',
                        data: quantities.length ? quantities : [50, 45, 40, 35, 30],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateStockChart(type) {
            if (reportCharts.stockMovement) {
                reportCharts.stockMovement.config.type = type;
                reportCharts.stockMovement.update();
                
                // Update button states
                document.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === type) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function updateInsights() {
            // Refresh report data
            initReports();
        }



        function viewProductDetails() {
            showNotification('Product details functionality coming soon', 'info');
        }

        function viewTimeAnalytics() {
            showNotification('Time analytics functionality coming soon', 'info');
        }

        function viewDetails(id) {
            showNotification(`Viewing details for ${id}`, 'info');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container') || createNotificationContainer();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNotification(notification.querySelector('.notification-close'));
                }
            }, 5000);
        }

        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
            `;
            document.body.appendChild(container);
            return container;
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease-in-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        // Header Functions
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('active');
            
            // Close on outside click
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.user-menu-wrapper')) {
                    dropdown.classList.remove('active');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function globalSearch(searchTerm) {
            // Implement global search functionality
            console.log('Searching for:', searchTerm);
            // You can add search logic here
        }

        function showProfile() {
            showNotification('Profile page coming soon', 'info');
        }

        function showSettings() {
            showNotification('Settings panel coming soon', 'info');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showNotification('Logging out...', 'info');
                
                // Clear all session data
                sessionStorage.clear();
                localStorage.removeItem('rememberedUser');
                
                setTimeout(() => {
                    window.location.href = './unified-login.html';
                }, 1000);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            showSection('dashboard');
            
            // Load transactions on page load
            loadTransactions();
            
            // Initialize filter indicators
            setTimeout(() => {
                updateFilterIndicators();
            }, 100);
            
            // Restore sidebar collapsed state
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                const topHeader = document.querySelector('.top-header');
                
                sidebar.classList.add('collapsed');
                if (mainContent) mainContent.style.marginLeft = '70px';
                if (topHeader) topHeader.style.left = '70px';
            }
            
            // Handle responsive sidebar
            window.addEventListener('resize', function() {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    mainContent.style.marginLeft = '';
                    document.body.style.overflow = 'auto';
                }
            });

            // Add notification styles
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        margin-bottom: 10px;
                        padding: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        animation: slideIn 0.3s ease-out;
                        border-left: 4px solid #3b82f6;
                    }
                    
                    .notification-success { border-left-color: #10b981; }
                    .notification-error { border-left-color: #ef4444; }
                    .notification-warning { border-left-color: #f59e0b; }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        flex: 1;
                    }
                    
                    .notification-close {
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 4px;
                        color: #6b7280;
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        });
    </script>
</body>
</html>